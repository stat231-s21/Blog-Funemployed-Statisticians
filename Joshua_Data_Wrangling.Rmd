---
title: "Josh_DataWrangling"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
```

```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
```

## HPI vs CPi and SP&500 vs Case Shiller HPI

```{r}
#Import CPI
CPI <- read_excel("/home/class21/jokim21/Git/Data-Science-Repo/Blog/Excel_Sheets/USACPIALLMINMEI.xls", range = "A11:B265") %>%
  rename(Date = "observation_date", ConsumerPriceIndex = "USACPIALLMINMEI") %>%
  mutate(Date = as.Date(as.character(Date), format = "%Y-%m-%d"))
  
  group_by()
  
#Import HPI
HPI <- read_excel("/home/class21/jokim21/Git/Data-Science-Repo/Blog/Excel_Sheets/CSUSHPINSA.xls", range = "A11:B265") %>%
  rename(Date = "observation_date", HousingPriceIndex = "CSUSHPINSA") %>%
  mutate(Date = as.Date(as.character(Date), format = "%Y-%m-%d"))

#Bind Together
CPIHPI <- HPI %>%
  left_join(CPI, by = "Date") %>%
  pivot_longer(!Date, values_to = "Index_Values", names_to = "Index_Type")

#Read S&P vs HPI data into R
SPHomePrice <- read_excel("/home/class21/jokim21/Git/Blog-Funemployed-Statisticians/Datasets/Joshua/sp-500-vs-home-prices.xls.xlsx") %>%
  rename(DateTime = "S&P 500 vs. Home Prices", "SP_500" = "...2", "Case_Shiller_Home_Price_Index" = "...3") %>%
  filter(DateTime > "2019-02-01") %>%
  filter(DateTime != "DateTime") %>%
  mutate(
    Date = as.Date(DateTime, format = "%Y-%m-%d"),
    MY = format(Date, format = "%Y-%m"),
    SP_500 = as.double(SP_500),
    Case_Shiller_Home_Price_Index = as.double(Case_Shiller_Home_Price_Index)
    ) %>%
  select(-DateTime) %>%
  pivot_longer(!Date & !MY, names_to = "Index_Type", values_to = "Index_Value") %>%
  filter(Index_Value != "NA") %>%
  group_by(MY) %>%
  filter(Date == max(Date)) %>%
  ungroup() %>%
  arrange(Index_Type, Date) %>%
  mutate(
    pct_chg = as.double(100 * (Index_Value - lag(Index_Value))/lag(Index_Value))
         ) %>%
  within(pct_chg[Date == '2019-02-28'] <- as.numeric('0'))
```

## Building Permit vs Construction Material Index Percentage Change

```{r}
# Extracting Building Permit Data
BP202002 <- read_excel("/home/class21/jokim21/Git/Data-Science-Repo/Blog/Excel_Sheets/statemonthly_202002.xls", range = "A8:G74") %>%
  rename(Region = "...1") %>%
  filter(Total != "NA") %>%
  filter(!Region == "Northeast Region") %>%
  filter(!Region == "New England Division") %>%   
  filter(!Region == "Middle Atlantic Division") %>%   
  filter(!Region == "Midwest Region") %>%   
  filter(!Region == "East North Central Division") %>%   
  filter(!Region == "West North Central Division") %>%   
  filter(!Region == "South Region") %>%   
  filter(!Region == "South Atlantic Division") %>%   
  filter(!Region == "East South Central Division") %>%   
  filter(!Region == "West South Central Division") %>%   
  filter(!Region == "West Region") %>%   
  filter(!Region == "Mountain Division") %>%   
  filter(!Region == "Pacific Division") %>%
  pivot_longer(cols = !Region, names_to = "Housing_Type", values_to = "Count") %>%
  mutate(Date = as.Date("02-01-2020", "%m-%d-%Y"))

BP202003 <- read_excel("/home/class21/jokim21/Git/Data-Science-Repo/Blog/Excel_Sheets/statemonthly_202003.xls", range = "A8:G74") %>%
  rename(Region = "...1") %>%
  filter(Total != "NA") %>%
  filter(!Region == "Northeast Region") %>%
  filter(!Region == "New England Division") %>%   
  filter(!Region == "Middle Atlantic Division") %>%   
  filter(!Region == "Midwest Region") %>%   
  filter(!Region == "East North Central Division") %>%   
  filter(!Region == "West North Central Division") %>%   
  filter(!Region == "South Region") %>%   
  filter(!Region == "South Atlantic Division") %>%   
  filter(!Region == "East South Central Division") %>%   
  filter(!Region == "West South Central Division") %>%   
  filter(!Region == "West Region") %>%   
  filter(!Region == "Mountain Division") %>%   
  filter(!Region == "Pacific Division") %>%
  pivot_longer(cols = !Region, names_to = "Housing_Type", values_to = "Count") %>%
  mutate(Date = as.Date("03-01-2020", "%m-%d-%Y"))

BP202004 <- read_excel("/home/class21/jokim21/Git/Data-Science-Repo/Blog/Excel_Sheets/statemonthly_202004.xls", range = "A8:G74") %>%
  rename(Region = "...1") %>%
  filter(Total != "NA") %>%
  filter(!Region == "Northeast Region") %>%
  filter(!Region == "New England Division") %>%   
  filter(!Region == "Middle Atlantic Division") %>%   
  filter(!Region == "Midwest Region") %>%   
  filter(!Region == "East North Central Division") %>%   
  filter(!Region == "West North Central Division") %>%   
  filter(!Region == "South Region") %>%   
  filter(!Region == "South Atlantic Division") %>%   
  filter(!Region == "East South Central Division") %>%   
  filter(!Region == "West South Central Division") %>%   
  filter(!Region == "West Region") %>%   
  filter(!Region == "Mountain Division") %>%   
  filter(!Region == "Pacific Division") %>%
  pivot_longer(cols = !Region, names_to = "Housing_Type", values_to = "Count") %>%
  mutate(Date = as.Date("04-01-2020", "%m-%d-%Y"))

BP202005 <- read_excel("/home/class21/jokim21/Git/Data-Science-Repo/Blog/Excel_Sheets/statemonthly_202005.xls", range = "A8:G74") %>%
  rename(Region = "...1") %>%
  filter(Total != "NA") %>%
  filter(!Region == "Northeast Region") %>%
  filter(!Region == "New England Division") %>%   
  filter(!Region == "Middle Atlantic Division") %>%   
  filter(!Region == "Midwest Region") %>%   
  filter(!Region == "East North Central Division") %>%   
  filter(!Region == "West North Central Division") %>%   
  filter(!Region == "South Region") %>%   
  filter(!Region == "South Atlantic Division") %>%   
  filter(!Region == "East South Central Division") %>%   
  filter(!Region == "West South Central Division") %>%   
  filter(!Region == "West Region") %>%   
  filter(!Region == "Mountain Division") %>%   
  filter(!Region == "Pacific Division") %>%
  pivot_longer(cols = !Region, names_to = "Housing_Type", values_to = "Count") %>%
  mutate(Date = as.Date("05-01-2020", "%m-%d-%Y"))

BP202006 <- read_excel("/home/class21/jokim21/Git/Data-Science-Repo/Blog/Excel_Sheets/statemonthly_202006.xls", range = "A8:G74") %>%
  rename(Region = "...1") %>%
  filter(Total != "NA") %>%
  filter(!Region == "Northeast Region") %>%
  filter(!Region == "New England Division") %>%   
  filter(!Region == "Middle Atlantic Division") %>%   
  filter(!Region == "Midwest Region") %>%   
  filter(!Region == "East North Central Division") %>%   
  filter(!Region == "West North Central Division") %>%   
  filter(!Region == "South Region") %>%   
  filter(!Region == "South Atlantic Division") %>%   
  filter(!Region == "East South Central Division") %>%   
  filter(!Region == "West South Central Division") %>%   
  filter(!Region == "West Region") %>%   
  filter(!Region == "Mountain Division") %>%   
  filter(!Region == "Pacific Division") %>%
  pivot_longer(cols = !Region, names_to = "Housing_Type", values_to = "Count") %>%
  mutate(Date = as.Date("06-01-2020", "%m-%d-%Y"))

BP202007 <- read_excel("/home/class21/jokim21/Git/Data-Science-Repo/Blog/Excel_Sheets/statemonthly_202007.xls", range = "A8:G74") %>%
  rename(Region = "...1") %>%
  filter(Total != "NA") %>%
  filter(!Region == "Northeast Region") %>%
  filter(!Region == "New England Division") %>%   
  filter(!Region == "Middle Atlantic Division") %>%   
  filter(!Region == "Midwest Region") %>%   
  filter(!Region == "East North Central Division") %>%   
  filter(!Region == "West North Central Division") %>%   
  filter(!Region == "South Region") %>%   
  filter(!Region == "South Atlantic Division") %>%   
  filter(!Region == "East South Central Division") %>%   
  filter(!Region == "West South Central Division") %>%   
  filter(!Region == "West Region") %>%   
  filter(!Region == "Mountain Division") %>%   
  filter(!Region == "Pacific Division") %>%
  pivot_longer(cols = !Region, names_to = "Housing_Type", values_to = "Count") %>%
  mutate(Date = as.Date("07-01-2020", "%m-%d-%Y"))

BP202008 <- read_excel("/home/class21/jokim21/Git/Data-Science-Repo/Blog/Excel_Sheets/statemonthly_202008.xls", range = "A8:G74") %>%
 rename(Region = "...1") %>%
  filter(Total != "NA") %>%
  filter(!Region == "Northeast Region") %>%
  filter(!Region == "New England Division") %>%   
  filter(!Region == "Middle Atlantic Division") %>%   
  filter(!Region == "Midwest Region") %>%   
  filter(!Region == "East North Central Division") %>%   
  filter(!Region == "West North Central Division") %>%   
  filter(!Region == "South Region") %>%   
  filter(!Region == "South Atlantic Division") %>%   
  filter(!Region == "East South Central Division") %>%   
  filter(!Region == "West South Central Division") %>%   
  filter(!Region == "West Region") %>%   
  filter(!Region == "Mountain Division") %>%   
  filter(!Region == "Pacific Division") %>%
  pivot_longer(cols = !Region, names_to = "Housing_Type", values_to = "Count") %>%
  mutate(Date = as.Date("08-01-2020", "%m-%d-%Y"))

BP202009 <- read_excel("/home/class21/jokim21/Git/Data-Science-Repo/Blog/Excel_Sheets/statemonthly_202009.xls", range = "A8:G74") %>%
 rename(Region = "...1") %>%
  filter(Total != "NA") %>%
  filter(!Region == "Northeast Region") %>%
  filter(!Region == "New England Division") %>%   
  filter(!Region == "Middle Atlantic Division") %>%   
  filter(!Region == "Midwest Region") %>%   
  filter(!Region == "East North Central Division") %>%   
  filter(!Region == "West North Central Division") %>%   
  filter(!Region == "South Region") %>%   
  filter(!Region == "South Atlantic Division") %>%   
  filter(!Region == "East South Central Division") %>%   
  filter(!Region == "West South Central Division") %>%   
  filter(!Region == "West Region") %>%   
  filter(!Region == "Mountain Division") %>%   
  filter(!Region == "Pacific Division") %>%
  pivot_longer(cols = !Region, names_to = "Housing_Type", values_to = "Count") %>%
  mutate(Date = as.Date("09-01-2020", "%m-%d-%Y"))

BP202010 <- read_excel("/home/class21/jokim21/Git/Data-Science-Repo/Blog/Excel_Sheets/statemonthly_202010.xls", range = "A8:G74") %>%
  rename(Region = "...1") %>%
  filter(Total != "NA") %>%
  filter(!Region == "Northeast Region") %>%
  filter(!Region == "New England Division") %>%   
  filter(!Region == "Middle Atlantic Division") %>%   
  filter(!Region == "Midwest Region") %>%   
  filter(!Region == "East North Central Division") %>%   
  filter(!Region == "West North Central Division") %>%   
  filter(!Region == "South Region") %>%   
  filter(!Region == "South Atlantic Division") %>%   
  filter(!Region == "East South Central Division") %>%   
  filter(!Region == "West South Central Division") %>%   
  filter(!Region == "West Region") %>%   
  filter(!Region == "Mountain Division") %>%   
  filter(!Region == "Pacific Division") %>%
  pivot_longer(cols = !Region, names_to = "Housing_Type", values_to = "Count") %>%
  mutate(Date = as.Date("10-01-2020", "%m-%d-%Y"))

BP202011 <- read_excel("/home/class21/jokim21/Git/Data-Science-Repo/Blog/Excel_Sheets/statemonthly_202011.xls", range = "A8:G74") %>%
  rename(Region = "...1") %>%
  filter(Total != "NA") %>%
  filter(!Region == "Northeast Region") %>%
  filter(!Region == "New England Division") %>%   
  filter(!Region == "Middle Atlantic Division") %>%   
  filter(!Region == "Midwest Region") %>%   
  filter(!Region == "East North Central Division") %>%   
  filter(!Region == "West North Central Division") %>%   
  filter(!Region == "South Region") %>%   
  filter(!Region == "South Atlantic Division") %>%   
  filter(!Region == "East South Central Division") %>%   
  filter(!Region == "West South Central Division") %>%   
  filter(!Region == "West Region") %>%   
  filter(!Region == "Mountain Division") %>%   
  filter(!Region == "Pacific Division") %>%
  pivot_longer(cols = !Region, names_to = "Housing_Type", values_to = "Count") %>%
  mutate(Date = as.Date("11-01-2020", "%m-%d-%Y"))

BP202012 <- read_excel("/home/class21/jokim21/Git/Data-Science-Repo/Blog/Excel_Sheets/statemonthly_202012.xls", range = "A8:G74") %>%
  rename(Region = "...1") %>%
  filter(Total != "NA") %>%
  filter(!Region == "Northeast Region") %>%
  filter(!Region == "New England Division") %>%   
  filter(!Region == "Middle Atlantic Division") %>%   
  filter(!Region == "Midwest Region") %>%   
  filter(!Region == "East North Central Division") %>%   
  filter(!Region == "West North Central Division") %>%   
  filter(!Region == "South Region") %>%   
  filter(!Region == "South Atlantic Division") %>%   
  filter(!Region == "East South Central Division") %>%   
  filter(!Region == "West South Central Division") %>%   
  filter(!Region == "West Region") %>%   
  filter(!Region == "Mountain Division") %>%   
  filter(!Region == "Pacific Division") %>%
  pivot_longer(cols = !Region, names_to = "Housing_Type", values_to = "Count") %>%
  mutate(Date = as.Date("12-01-2020", "%m-%d-%Y"))

BP202101 <- read_excel("/home/class21/jokim21/Git/Data-Science-Repo/Blog/Excel_Sheets/statemonthly_202101.xls", range = "A8:G74") %>%
  rename(Region = "...1") %>%
  filter(Total != "NA") %>%
  filter(!Region == "Northeast Region") %>%
  filter(!Region == "New England Division") %>%   
  filter(!Region == "Middle Atlantic Division") %>%   
  filter(!Region == "Midwest Region") %>%   
  filter(!Region == "East North Central Division") %>%   
  filter(!Region == "West North Central Division") %>%   
  filter(!Region == "South Region") %>%   
  filter(!Region == "South Atlantic Division") %>%   
  filter(!Region == "East South Central Division") %>%   
  filter(!Region == "West South Central Division") %>%   
  filter(!Region == "West Region") %>%   
  filter(!Region == "Mountain Division") %>%   
  filter(!Region == "Pacific Division") %>%
  pivot_longer(cols = !Region, names_to = "Housing_Type", values_to = "Count") %>%
  mutate(Date = as.Date("01-01-2021", "%m-%d-%Y"))

BP202102 <- read_excel("/home/class21/jokim21/Git/Data-Science-Repo/Blog/Excel_Sheets/statemonthly_202102.xls", range = "A8:G74") %>%
  rename(Region = "...1") %>%
  filter(Total != "NA") %>%
  filter(!Region == "Northeast Region") %>%
  filter(!Region == "New England Division") %>%   
  filter(!Region == "Middle Atlantic Division") %>%   
  filter(!Region == "Midwest Region") %>%   
  filter(!Region == "East North Central Division") %>%   
  filter(!Region == "West North Central Division") %>%   
  filter(!Region == "South Region") %>%   
  filter(!Region == "South Atlantic Division") %>%   
  filter(!Region == "East South Central Division") %>%   
  filter(!Region == "West South Central Division") %>%   
  filter(!Region == "West Region") %>%   
  filter(!Region == "Mountain Division") %>%   
  filter(!Region == "Pacific Division") %>%
  pivot_longer(cols = !Region, names_to = "Housing_Type", values_to = "Count") %>%
  mutate(Date = as.Date("02-01-2021", "%m-%d-%Y"))

#Building Permits binding together into one dataset
BuildingPermits <- bind_rows(BP202002, BP202003, BP202004, BP202005, BP202006, BP202007, BP202008, BP202009, BP202010, BP202011, BP202012, BP202101, BP202102) %>%
  filter(Housing_Type == "Total") %>%
  select(-Housing_Type) %>%
  arrange(Region) %>%
  mutate(pct_chg = as.numeric(100 * (Count - lag(Count))/lag(Count))) %>%
  within(pct_chg[Date == '2020-02-01'] <- as.numeric('0'))
  

#Import Construction Material 
ConstructionMaterial <- read_excel("/home/class21/jokim21/Git/Data-Science-Repo/Blog/Excel_Sheets/Construction Materials.xls", range = "A30:B42", col_names = FALSE) %>%
  rename(Date = "...1",
         Construction_Material_Index = "...2") %>%
  mutate(
    pct_chg = as.numeric(100 * (Construction_Material_Index - lag(Construction_Material_Index))/lag(Construction_Material_Index))
  ) %>%
  within(pct_chg[Construction_Material_Index == "234.6"] <- as.numeric('0'))

write_csv(FullUnemp, file="Unemployment Shiny Application/FullUnemp.csv")
```

# Visualizations
```{r}
SPplot <- ggplot(SPHomePrice, aes(x=Date, y=pct_chg, group = Index_Type, color = Index_Type)) +
  geom_line() +
  ylab("Percentage Change of Index") +
  theme(legend.position="bottom", legend.background = element_rect(fill="lightblue", size=0.5, linetype="solid")) +
  labs(color = "Index Type") +
  ggtitle("S&P 500 vs. Case Shiller Housing Price Index")
            
SPplot

Indexplot <- CPIHPI %>%
  ggplot(aes(x = Date, y = Index_Values, group = Index_Type, color = Index_Type)) +
  geom_line() +
  geom_point() +
  ylab("Index Values") +
  theme(legend.position="bottom", legend.background = element_rect(fill="lightblue", size=0.5, linetype="solid")) +
  labs(color = "Index Type") +
  ggtitle("Consumer Price Index vs. Housing Price Index")

Indexplot

BPplot <- BuildingPermits %>%
  filter(Region == "United States") %>%
  ggplot(aes(x = Date, y = pct_chg)) + 
  geom_line() +
  geom_point() +
  ylab("Percentage Change of Approved Building Permits") +
  theme(legend.position="bottom", legend.background = element_rect(fill="lightblue", size=0.5, linetype="solid")) +
  ggtitle("Percentage Change of Approved Building Permits")

BPplot

CMplot <- ConstructionMaterial %>%
  ggplot(aes(x = Date, y = pct_chg)) + 
  geom_line() +
  geom_area() +
  ylab("Percentage Change of Construction Material Index") +
  theme(legend.position="bottom", legend.background = element_rect(fill="lightblue", size=0.5, linetype="solid")) +
  ggtitle("Percentage Change of Construction Material Index")

CMplot
```
